<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SafetyControl v0.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Fonte para assinatura -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
    <!-- Lib para Gerar QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Lib para Gerar PDF (jsPDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .scroller::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroller::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .scroller::-webkit-scrollbar-track { background-color: #f1f5f9; }
        .signature-font { font-family: 'Dancing Script', cursive; font-size: 1.2rem; color: #1e40af; }

        /* Estilos de Impressão */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: white; padding: 20px; z-index: 9999; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden bg-slate-50">

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden glass transition-opacity"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-30 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 no-print">
        <div class="p-6 border-b border-slate-800 flex items-center justify-between gap-3">
            <div class="flex items-center gap-2">
                <i class="fas fa-shield-alt text-blue-500 text-2xl"></i>
                <span class="font-bold text-xl tracking-tight">SafetyControl</span>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button onclick="switchView('dashboard'); toggleSidebarIfMobile()" id="nav-dashboard" class="nav-btn w-full flex items-center gap-3 bg-blue-600 text-white p-3 rounded-lg shadow-lg transition text-left">
                <i class="fas fa-chart-pie w-6 text-center"></i> Dashboard
            </button>
            <button onclick="switchView('epis'); toggleSidebarIfMobile()" id="nav-epis" class="nav-btn w-full flex items-center gap-3 text-slate-400 p-3 rounded-lg hover:bg-slate-800 transition text-left">
                <i class="fas fa-hard-hat w-6 text-center"></i> Cadastrar EPIs
            </button>
            <button onclick="switchView('employees'); toggleSidebarIfMobile()" id="nav-employees" class="nav-btn w-full flex items-center gap-3 text-slate-400 p-3 rounded-lg hover:bg-slate-800 transition text-left">
                <i class="fas fa-users w-6 text-center"></i> Funcionários
            </button>
            <button onclick="switchView('delivery'); toggleSidebarIfMobile()" id="nav-delivery" class="nav-btn w-full flex items-center gap-3 text-slate-400 p-3 rounded-lg hover:bg-slate-800 transition text-left">
                <i class="fas fa-box-open w-6 text-center"></i> Gestão de Entrega
            </button>
            
            <button onclick="logout()" class="w-full flex items-center gap-3 text-red-400 p-3 rounded-lg hover:bg-slate-800 transition mt-auto text-left border-t border-slate-800 pt-4">
                <i class="fas fa-sign-out-alt w-6 text-center"></i> Sair
            </button>
        </nav>

        <div class="p-4 bg-slate-950 text-xs text-center text-slate-600">
            Versão 0.2
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative w-full">
        <header class="bg-white p-4 shadow-sm flex justify-between items-center md:hidden no-print z-10">
            <button onclick="toggleSidebar()" class="text-slate-700 p-2 rounded hover:bg-slate-100"><i class="fas fa-bars fa-lg"></i></button>
            <span class="font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-shield-alt text-blue-600"></i> SafetyControl</span>
            <div class="w-8"></div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-10 relative scroller">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="view-section fade-in pb-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 md:mb-8 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Visão Geral</h1>
                        <p class="text-slate-500 mt-1">Status do estoque em tempo real.</p>
                    </div>
                    <button onclick="loadData()" class="bg-white border border-slate-300 px-4 py-2 rounded-lg text-sm hover:bg-slate-50 text-slate-700 font-medium shadow-sm">
                        <i class="fas fa-sync-alt mr-2"></i> Atualizar
                    </button>
                </div>
                <!-- KPIs -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Entregas Realizadas</p>
                        <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-2" id="kpi-logs">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-yellow-500">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Entregas Pendentes</p>
                        <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-2" id="kpi-pending">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-green-500">
                        <p class="text-xs font-bold text-gray-400 uppercase tracking-wider">Estoque Total</p>
                        <h3 class="text-2xl md:text-3xl font-bold text-slate-800 mt-2" id="kpi-total">0</h3>
                    </div>
                </div>
                <!-- Tabela de Inventário Rápido -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-slate-200">
                    <div class="p-5 border-b border-slate-100">
                        <h3 class="font-bold text-lg text-slate-800">Inventário Rápido</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="p-4">Item</th>
                                    <th class="p-4 text-center">Qtd.</th>
                                    <th class="p-4 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-inventory-table" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: CADASTRAR EPIs (NOVO) -->
            <div id="view-epis" class="view-section hidden fade-in pb-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Estoque de EPIs</h1>
                        <p class="text-slate-500 mt-1">Gerencie os equipamentos disponíveis.</p>
                    </div>
                    <button onclick="openEPIModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg text-sm hover:bg-blue-700 shadow-md font-medium flex items-center">
                        <i class="fas fa-plus mr-2"></i> Novo EPI
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="p-4 pl-6">Nome do EPI</th>
                                    <th class="p-4">CA (Cert. Aprovação)</th>
                                    <th class="p-4 text-center">Estoque Atual</th>
                                    <th class="p-4 text-center">Mínimo</th>
                                    <th class="p-4 text-right pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="epis-table" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: FUNCIONÁRIOS -->
            <div id="view-employees" class="view-section hidden fade-in pb-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Funcionários</h1>
                        <p class="text-slate-500 mt-1">Gestão de equipe e cadastros.</p>
                    </div>
                    <button onclick="openEmployeeModal()" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg text-sm hover:bg-blue-700 shadow-md font-medium flex items-center">
                        <i class="fas fa-plus mr-2"></i> Novo Funcionário
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[900px]">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase">
                                <tr>
                                    <th class="p-4 pl-6">Nome / Foto</th>
                                    <th class="p-4">Cargo / Setor</th>
                                    <th class="p-4">CPF</th>
                                    <th class="p-4 text-center">Status</th>
                                    <th class="p-4 text-right pr-6">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: GESTÃO DE ENTREGA -->
            <div id="view-delivery" class="view-section hidden fade-in pb-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-4">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Gestão de Entrega</h1>
                        <p class="text-slate-500 mt-1">Gerar ordens de entrega e QR Code.</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Formulário de Nova Entrega -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-lg mb-4 border-b pb-2">Nova Solicitação de EPI</h3>
                        <form onsubmit="event.preventDefault(); generateDeliveryOrder();">
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-700 mb-1">Funcionário</label>
                                <select id="delivery-employee" class="w-full border p-2 rounded-lg bg-gray-50" required>
                                    <option value="">Selecione...</option>
                                    <!-- JS Popula -->
                                </select>
                            </div>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-700 mb-2">Selecione os EPIs e a Quantidade</label>
                                <div id="delivery-epi-list" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded bg-gray-50">
                                    <!-- JS Popula checkbox + input qtd -->
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Data Prevista</label>
                                    <input type="date" id="delivery-date" class="w-full border p-2 rounded-lg" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-1">Responsável</label>
                                    <input type="text" id="delivery-responsible" class="w-full border p-2 rounded-lg bg-gray-100" value="Admin" readonly>
                                </div>
                            </div>

                            <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold shadow">
                                <i class="fas fa-file-pdf mr-2"></i> Gerar Declaração & PDF
                            </button>
                        </form>
                    </div>

                    <!-- Lista de Pendências -->
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
                        <div class="p-6 border-b border-slate-100 bg-yellow-50">
                            <h3 class="font-bold text-lg text-yellow-800">Entregas Pendentes</h3>
                        </div>
                        <div class="flex-1 overflow-y-auto p-0 max-h-[500px]" id="pending-deliveries-list">
                            <!-- JS Popula -->
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal Cadastro Funcionário -->
    <div id="employeeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4 no-print overflow-y-auto">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transform transition-all m-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 flex justify-between items-center">
                Cadastro de Funcionário
                <button onclick="closeEmployeeModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </h2>
            <form onsubmit="event.preventDefault(); saveEmployee();">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2 flex justify-center mb-4">
                        <label class="cursor-pointer group relative">
                            <div class="w-24 h-24 rounded-full bg-gray-200 overflow-hidden border-2 border-gray-300 group-hover:border-blue-500">
                                <img id="newEmpPhotoPreview" src="https://ui-avatars.com/api/?name=User" class="w-full h-full object-cover">
                            </div>
                            <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition text-white text-xs">Alterar</div>
                            <input type="file" id="newEmpPhoto" class="hidden" accept="image/*" onchange="previewPhoto(this)">
                        </label>
                    </div>
                    <div class="md:col-span-2">
                        <label class="label-form">Nome Completo *</label>
                        <input type="text" id="newEmpName" required class="input-form" placeholder="Ex: Maria Silva">
                    </div>
                    <div>
                        <label class="label-form">CPF *</label>
                        <input type="text" id="newEmpCPF" required class="input-form" placeholder="000.000.000-00" oninput="maskCPF(this)" maxlength="14">
                    </div>
                    <div>
                        <label class="label-form">Data Nascimento</label>
                        <input type="date" id="newEmpBirth" class="input-form">
                    </div>
                    <div>
                        <label class="label-form">Cargo *</label>
                        <input type="text" id="newEmpRole" required class="input-form" placeholder="Ex: Soldador">
                    </div>
                    <div>
                        <label class="label-form">Setor</label>
                        <input type="text" id="newEmpSector" class="input-form" placeholder="Ex: Produção">
                    </div>
                    <div>
                        <label class="label-form">Empresa / Unidade</label>
                        <input type="text" id="newEmpUnit" class="input-form" placeholder="Ex: Matriz">
                    </div>
                    <div>
                        <label class="label-form">Data Admissão</label>
                        <input type="date" id="newEmpAdmission" class="input-form">
                    </div>
                    <div>
                        <label class="label-form">Status</label>
                        <select id="newEmpStatus" class="input-form">
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                            <option value="Férias">Férias</option>
                        </select>
                    </div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button type="button" onclick="closeEmployeeModal()" class="flex-1 py-3 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium">Salvar Funcionário</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cadastro EPI (NOVO) -->
    <div id="epiModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 backdrop-blur-sm p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all m-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 flex justify-between items-center">
                Cadastrar EPI
                <button onclick="closeEPIModal()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </h2>
            <form onsubmit="event.preventDefault(); saveEPI();">
                <div class="space-y-4">
                    <div>
                        <label class="label-form">Nome do Equipamento *</label>
                        <input type="text" id="newEPIName" required class="input-form" placeholder="Ex: Capacete com Jugular">
                    </div>
                    <div>
                        <label class="label-form">CA (Certificado de Aprovação)</label>
                        <input type="text" id="newEPICA" class="input-form" placeholder="Ex: 12345">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="label-form">Estoque Atual *</label>
                            <input type="number" id="newEPIQty" required class="input-form" placeholder="0">
                        </div>
                        <div>
                            <label class="label-form">Estoque Mínimo</label>
                            <input type="number" id="newEPIMin" required class="input-form" placeholder="5">
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex gap-3">
                    <button type="button" onclick="closeEPIModal()" class="flex-1 py-3 text-gray-600 hover:bg-gray-100 rounded-lg font-medium">Cancelar</button>
                    <button type="submit" class="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow font-medium">Salvar EPI</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Área oculta para gerar QR Code para o PDF -->
    <div id="qrcode-container" style="position: absolute; left: -9999px; top: -9999px;"></div>

    <script>
        // --- UTILITÁRIOS ---
        const $ = (id) => document.getElementById(id);
        const styleInput = "w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition";
        document.querySelectorAll('.input-form').forEach(el => el.className = styleInput);
        document.querySelectorAll('.label-form').forEach(el => el.className = "block text-sm font-medium text-gray-700 mb-1");

        // Máscara CPF
        function maskCPF(i){
            var v = i.value;
            if(isNaN(v[v.length-1])){ i.value = v.substring(0, v.length-1); return; }
            i.setAttribute("maxlength", "14");
            if (v.length == 3 || v.length == 7) i.value += ".";
            if (v.length == 11) i.value += "-";
        }

        // --- NAVEGAÇÃO ---
        function switchView(view) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('bg-blue-600', 'text-white'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.add('text-slate-400'));
            
            $(`view-${view}`).classList.remove('hidden');
            const nav = $(`nav-${view}`);
            nav.classList.add('bg-blue-600', 'text-white');
            nav.classList.remove('text-slate-400');

            if(view === 'dashboard') loadDashboard();
            if(view === 'epis') loadEPIs();
            if(view === 'employees') loadEmployees();
            if(view === 'delivery') loadDeliveryManagement();
        }
        
        function toggleSidebar() {
            const sb = $('sidebar');
            sb.classList.toggle('-translate-x-full');
            $('mobile-overlay').classList.toggle('hidden');
        }

        // --- DADOS ---
        function getDB(key) { return JSON.parse(localStorage.getItem(key)) || []; }
        function setDB(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

        // --- DASHBOARD ---
        function loadDashboard() {
            const logs = getDB('sc_logs');
            const pending = getDB('sc_pending_deliveries').filter(d => d.status === 'Pendente');
            const inv = getDB('sc_inventory');
            
            $('kpi-logs').innerText = logs.length;
            $('kpi-pending').innerText = pending.length;
            $('kpi-total').innerText = inv.reduce((a, b) => a + parseInt(b.qty), 0);

            const tbody = $('dashboard-inventory-table');
            tbody.innerHTML = '';
            inv.forEach(item => {
                const status = item.qty < item.min ? 'Repor' : 'OK';
                const color = item.qty < item.min ? 'text-red-500' : 'text-green-500';
                tbody.innerHTML += `<tr><td class="p-4">${item.name}</td><td class="p-4 text-center">${item.qty}</td><td class="p-4 text-center text-xs font-bold ${color}">${status}</td></tr>`;
            });
        }

        // --- GESTÃO DE EPIs (NOVO v0.2) ---
        function loadEPIs() {
            const inv = getDB('sc_inventory');
            const tbody = $('epis-table');
            tbody.innerHTML = '';

            if(inv.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhum EPI cadastrado.</td></tr>`;
                return;
            }

            inv.forEach((item, idx) => {
                const rowClass = item.qty < item.min ? 'bg-red-50' : 'hover:bg-slate-50';
                tbody.innerHTML += `
                    <tr class="${rowClass} border-b border-gray-100 transition">
                        <td class="p-4 pl-6 font-bold text-gray-700">${item.name}</td>
                        <td class="p-4 text-sm text-gray-500">${item.ca || '-'}</td>
                        <td class="p-4 text-center font-mono font-bold">${item.qty}</td>
                        <td class="p-4 text-center text-sm text-gray-400">${item.min}</td>
                        <td class="p-4 text-right pr-6">
                            <button onclick="deleteEPI(${idx})" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function openEPIModal() { $('epiModal').classList.remove('hidden'); }
        function closeEPIModal() { $('epiModal').classList.add('hidden'); }

        function saveEPI() {
            const newEPI = {
                id: Date.now(),
                name: $('newEPIName').value,
                ca: $('newEPICA').value,
                qty: parseInt($('newEPIQty').value),
                min: parseInt($('newEPIMin').value),
                icon: 'fa-hard-hat' // Padrão
            };

            const inv = getDB('sc_inventory');
            inv.push(newEPI);
            setDB('sc_inventory', inv);
            closeEPIModal();
            loadEPIs();
            // Limpa form
            $('newEPIName').value = '';
            $('newEPICA').value = '';
            $('newEPIQty').value = '';
            $('newEPIMin').value = '';
        }

        function deleteEPI(idx) {
            if(confirm("Remover este EPI do estoque?")) {
                const inv = getDB('sc_inventory');
                inv.splice(idx, 1);
                setDB('sc_inventory', inv);
                loadEPIs();
            }
        }

        // --- FUNCIONÁRIOS ---
        function loadEmployees() {
            const list = getDB('sc_employees');
            const tbody = $('employees-table');
            tbody.innerHTML = '';
            
            if(list.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhum funcionário cadastrado.</td></tr>`;
                return;
            }

            list.forEach((emp, idx) => {
                const statusColor = emp.status === 'Ativo' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500';
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50 border-b">
                        <td class="p-4 pl-6 flex items-center gap-3">
                            <img src="${emp.photo || 'https://ui-avatars.com/api/?name='+emp.name}" class="w-10 h-10 rounded-full object-cover border">
                            <div><p class="font-bold">${emp.name}</p></div>
                        </td>
                        <td class="p-4 text-sm">${emp.role}<br><span class="text-xs text-gray-400">${emp.sector || '-'}</span></td>
                        <td class="p-4 text-sm font-mono">${emp.cpf}</td>
                        <td class="p-4 text-center"><span class="text-xs px-2 py-1 rounded-full ${statusColor}">${emp.status}</span></td>
                        <td class="p-4 text-right pr-6">
                            <button onclick="deleteEmployee(${idx})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function openEmployeeModal() { $('employeeModal').classList.remove('hidden'); }
        function closeEmployeeModal() { $('employeeModal').classList.add('hidden'); }
        
        function previewPhoto(input) {
            if(input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => $('newEmpPhotoPreview').src = e.target.result;
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveEmployee() {
            const newEmp = {
                id: Date.now(),
                name: $('newEmpName').value,
                cpf: $('newEmpCPF').value,
                birth: $('newEmpBirth').value,
                role: $('newEmpRole').value,
                sector: $('newEmpSector').value,
                unit: $('newEmpUnit').value,
                admission: $('newEmpAdmission').value,
                status: $('newEmpStatus').value,
                photo: $('newEmpPhotoPreview').src.includes('data:') ? $('newEmpPhotoPreview').src : null
            };

            const db = getDB('sc_employees');
            db.push(newEmp);
            setDB('sc_employees', db);
            closeEmployeeModal();
            loadEmployees();
            alert("Funcionário salvo com sucesso!");
        }

        function deleteEmployee(idx) {
            if(confirm("Remover este funcionário?")) {
                const db = getDB('sc_employees');
                db.splice(idx, 1);
                setDB('sc_employees', db);
                loadEmployees();
            }
        }

        // --- GESTÃO DE ENTREGA (ATUALIZADO v0.2) ---
        function loadDeliveryManagement() {
            const emps = getDB('sc_employees');
            const select = $('delivery-employee');
            select.innerHTML = '<option value="">Selecione...</option>';
            emps.forEach(e => select.innerHTML += `<option value="${e.id}">${e.name} - ${e.cpf}</option>`);

            const inv = getDB('sc_inventory');
            const list = $('delivery-epi-list');
            list.innerHTML = '';
            
            // Lista com Input de Quantidade
            inv.forEach(item => {
                list.innerHTML += `
                    <div class="flex items-center justify-between p-2 hover:bg-gray-100 rounded border-b border-gray-100 last:border-0 transition">
                        <label class="flex items-center space-x-3 cursor-pointer flex-1">
                            <input type="checkbox" name="epi-check" value="${item.id}" class="form-checkbox h-5 w-5 text-blue-600 rounded transition duration-150 ease-in-out" onchange="toggleQtyInput(${item.id})">
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-gray-700">${item.name}</span>
                                <span class="text-xs text-gray-400">Estoque: ${item.qty}</span>
                            </div>
                        </label>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">Qtd:</span>
                            <input type="number" id="qty-${item.id}" value="1" min="1" max="${item.qty}" class="w-16 border border-gray-300 rounded-md p-1 text-center text-sm focus:ring-2 focus:ring-blue-500 outline-none transition disabled:bg-gray-100 disabled:text-gray-400" disabled>
                        </div>
                    </div>
                `;
            });

            loadPendingDeliveries();
        }

        function toggleQtyInput(id) {
            const checkbox = document.querySelector(`input[value="${id}"]`);
            const input = document.getElementById(`qty-${id}`);
            if (checkbox.checked) {
                input.disabled = false;
                input.focus();
            } else {
                input.disabled = true;
                input.value = 1;
            }
        }

        function generateDeliveryOrder() {
            const empId = $('delivery-employee').value;
            const checks = document.querySelectorAll('input[name="epi-check"]:checked');
            const date = $('delivery-date').value;

            if(!empId || checks.length === 0 || !date) { alert("Preencha todos os campos e selecione itens."); return; }

            const emp = getDB('sc_employees').find(e => e.id == empId);
            const inv = getDB('sc_inventory');
            const items = [];
            
            // Captura quantidade específica
            checks.forEach(c => {
                const i = inv.find(x => x.id == c.value);
                const qtyInput = document.getElementById(`qty-${i.id}`);
                const qty = parseInt(qtyInput.value) || 1;
                items.push({ id: i.id, name: i.name, qty: qty });
            });

            const delivery = {
                id: 'DEL-' + Date.now().toString().slice(-6),
                empId: emp.id,
                empName: emp.name,
                empRole: emp.role,
                empCPF: emp.cpf,
                items: items,
                datePredicted: date,
                status: 'Pendente',
                createdAt: new Date().toISOString()
            };

            const pending = getDB('sc_pending_deliveries');
            pending.push(delivery);
            setDB('sc_pending_deliveries', pending);

            printDeclaration(delivery);
            loadPendingDeliveries();
        }

        async function printDeclaration(d) {
            const qrContainer = $('qrcode-container');
            qrContainer.innerHTML = '';
            
            await new Promise(resolve => {
                new QRCode(qrContainer, {
                    text: JSON.stringify({ id: d.id, emp: d.empName, date: d.datePredicted }),
                    width: 150,
                    height: 150,
                    correctLevel : QRCode.CorrectLevel.H
                });
                setTimeout(resolve, 200);
            });

            let qrDataUrl = '';
            const canvas = qrContainer.querySelector('canvas');
            if (canvas) qrDataUrl = canvas.toDataURL('image/png');
            else { const img = qrContainer.querySelector('img'); if (img) qrDataUrl = img.src; }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setTextColor(0, 0, 0);
            const margin = 20;
            let y = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const maxLineWidth = pageWidth - (margin * 2);

            // --- HEADER ---
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("FICHA DE ENTREGA DE EPI", pageWidth / 2, y, { align: "center" });
            y += 10;
            
            // --- INTRO ---
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            const introText = `Eu, ${d.empName}, portador(a) do CPF nº ${d.empCPF || 'Não informado'}, declaro, para todos os efeitos previstos na legislação trabalhista, haver recebido gratuitamente da empresa Terceriza Condomínios Ltda, conforme disposto nos artigos 166 e 167 da C.L.T., na NR-06 (Equipamentos de Proteção Individual) e nos itens 1.4.2 e 1.5.5.1.2 da NR-01 – Disposições Gerais e Gerenciamento de Riscos Ocupacionais, após treinamento e orientação quanto ao uso adequado, aplicação, guarda, conservação, substituição e requisitos de higiene, em palestra realizada pelo Serviço Especializado em Segurança e Medicina do Trabalho – SESMT, o(s) Equipamento(s) de Proteção Individual abaixo descrito(s), doravante designado(s) como EPI(s), obrigando-me a utilizá-lo(s) sistematicamente no exercício de minhas atividades.`;
            const splitIntro = doc.splitTextToSize(introText, maxLineWidth);
            doc.text(splitIntro, margin, y);
            y += (splitIntro.length * 5) + 5;

            // --- ITENS ---
            doc.setFont("helvetica", "bold");
            doc.text("Itens a Receber:", margin, y);
            y += 6;

            doc.setFillColor(240, 240, 240);
            doc.rect(margin, y - 4, maxLineWidth, 6, 'F');
            doc.setFontSize(9);
            doc.text("Descrição do EPI", margin + 2, y);
            doc.text("Qtd", pageWidth - margin - 5, y, { align: "right" });
            y += 6;

            doc.setFont("helvetica", "normal");
            d.items.forEach(item => {
                doc.text(item.name || 'Item', margin + 2, y);
                doc.text(item.qty.toString(), pageWidth - margin - 5, y, { align: "right" });
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, y + 1, pageWidth - margin, y + 1);
                y += 6;
            });
            y += 5;

            // --- TERMOS ---
            const termsIntro = "Declaro ainda que estou ciente e de pleno acordo com os seguintes termos:";
            doc.text(termsIntro, margin, y);
            y += 6;

            const terms = [
                "a) O EPI será utilizado exclusivamente para a finalidade a que se destina, devendo qualquer alteração que o torne parcial ou totalmente danificado ser imediatamente comunicada à empresa;",
                "b) Responsabilizo-me pela guarda e conservação dos EPI(s) que me foram confiados e, na impossibilidade de seu uso, comunicarei a chefia imediatamente para as providências cabíveis, comprometendo-me a devolvê-lo(s) após o vencimento do prazo de duração estipulado;",
                "c) Estou ciente de que a falta de uso dos EPI(s) fornecidos pela empresa constitui ato faltoso, sujeito às sanções disciplinares previstas na legislação vigente, no Regulamento Interno e nas Normas de Segurança da Empresa;",
                "d) Reconheço expressamente que a não utilização dos EPI(s) configura falta grave, nos termos da alínea “h” do artigo 482 da C.L.T., caracterizando ato de indisciplina ou insubordinação, podendo ensejar a rescisão do contrato de trabalho por justa causa;",
                "e) Autorizo expressamente a empresa a proceder descontos em meus salários, vencimentos, gratificações ou indenizações referentes aos valores dos EPI(s) que porventura forem:\n   – Danificados propositadamente;\n   – Extraviados;\n   – Não devolvidos à empresa para substituição;",
                "f) Declaro que tomei ciência e estou de pleno acordo com os termos acima, assinando a presente de livre e espontânea vontade, após sua leitura nesta data."
            ];

            doc.setFontSize(9);
            terms.forEach(term => {
                const splitTerm = doc.splitTextToSize(term, maxLineWidth);
                if (y + (splitTerm.length * 4) > 270) { doc.addPage(); y = 20; }
                doc.text(splitTerm, margin, y);
                y += (splitTerm.length * 4) + 2;
            });

            y += 5;

            // --- ASSINATURA ---
            const today = new Date(d.datePredicted);
            const dateStr = `Data: ${today.getDate().toString().padStart(2, '0')} / ${(today.getMonth()+1).toString().padStart(2, '0')} / ${today.getFullYear()}`;
            doc.text(dateStr, margin, y);
            y += 15;

            if (y + 40 > 280) { doc.addPage(); y = 20; }
            
            doc.text("Assinatura do Funcionário:", margin, y);
            y += 8;
            doc.text(`Nome: ${d.empName}`, margin, y);
            doc.line(margin + 12, y, margin + 100, y);
            
            y += 15;

            if (y + 45 > 280) { doc.addPage(); y = 20; }
            doc.text("QR Code da Entrega:", margin, y);
            y += 5;
            if (qrDataUrl) doc.addImage(qrDataUrl, 'PNG', margin, y, 35, 35);
            
            const pageCount = doc.internal.getNumberOfPages();
            for(let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${pageCount} - Gerado por SafetyControl`, pageWidth / 2, 290, { align: "center" });
            }

            doc.save(`Declaracao_EPI_${d.empName.replace(/\s+/g, '_')}.pdf`);
        }

        function loadPendingDeliveries() {
            const list = getDB('sc_pending_deliveries');
            const container = $('pending-deliveries-list');
            container.innerHTML = '';

            if(list.length === 0) container.innerHTML = '<p class="p-6 text-center text-gray-400">Nenhuma entrega pendente.</p>';

            list.slice().reverse().forEach(d => {
                const color = d.status === 'Pendente' ? 'border-l-4 border-yellow-500' : 'border-l-4 border-green-500 opacity-60';
                container.innerHTML += `
                    <div class="bg-white p-4 border-b ${color} hover:bg-gray-50 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-sm">${d.empName}</p>
                                <p class="text-xs text-gray-500">ID: ${d.id}</p>
                            </div>
                            <span class="text-xs px-2 py-1 rounded bg-gray-100">${d.status}</span>
                        </div>
                        <div class="mt-2 text-xs text-gray-600">
                            ${d.items.map(i => `• ${i.name} (x${i.qty})`).join('<br>')}
                        </div>
                        ${d.status === 'Pendente' ? `<button onclick="reprint('${d.id}')" class="mt-2 text-xs text-blue-600 hover:underline">Baixar PDF</button>` : ''}
                    </div>
                `;
            });
        }

        function reprint(id) {
            const d = getDB('sc_pending_deliveries').find(x => x.id === id);
            if(d) printDeclaration(d);
        }

        function logout() { window.location.href='index.html'; }

        window.onload = function() {
            // Seed Data v0.2
            if(!localStorage.getItem('sc_inventory')) { 
                setDB('sc_inventory', [
                    {id:1, name:'Capacete Azul', qty:45, min:10, ca:'12345'},
                    {id:2, name:'Luvas de Raspa', qty:12, min:5, ca:'67890'}
                ]);
            }
            switchView('dashboard');
        }

    </script>
</body>
</html>
